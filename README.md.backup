<div align="center">

# üõ°Ô∏è SecretSentinel Scanner & Rotator

### **Intelligent Secret Detection & Rotation System**

[![TypeScript](https://img.shields.io/badge/TypeScript-5.9-blue?logo=typescript)](https://www.typescriptlang.org/)
[![Node.js](https://img.shields.io/badge/Node.js-18+-green?logo=node.js)](https://nodejs.org/)
[![License](https://img.shields.io/badge/License-MIT-yellow)](./LICENSE)

*A production-grade CLI tool for scanning repositories to detect secrets and safely rotating them through pluggable backends.*

[Features](#-features) ‚Ä¢ [Quick Start](#-quick-start) ‚Ä¢ [Documentation](#-documentation) ‚Ä¢ [Configuration](#%EF%B8%8F-configuration) ‚Ä¢ [Security](#-security)

</div>

---

## ‚ú® Features

<table>
<tr>
<td width="50%">

### üîç **Advanced Scanning**
- **Multi-format support** - Scan text files, archives (ZIP/TAR.GZ), `.env`, and Dockerfiles
- **Smart ignoring** - Respects `.gitignore`, `.secretignore`, and custom patterns
- **High-performance** - Concurrent scanning with worker thread pool support
- **ML integration** - Optional ML model hooks for enhanced detection
- **Entropy detection** - Flag high-entropy tokens (base64/hex patterns)

</td>
<td width="50%">

### üîÑ **Safe Rotation**
- **Atomic updates** - File changes with automatic backups & rollback
- **Multiple backends** - Local file, AWS Secrets Manager, HashiCorp Vault
- **Pluggable architecture** - Write custom rotators in TypeScript or JavaScript
- **Interactive mode** - Review and approve each change
- **Audit logging** - NDJSON event stream with HMAC signatures

</td>
</tr>
<tr>
<td width="50%">

### üìä **Enterprise Ready**
- **CI/CD integration** - Fail pipelines based on findings thresholds
- **Metrics & monitoring** - Built-in Prometheus metrics HTTP server
- **Curated rulesets** - Marketplace with signed ruleset support
- **Policy enforcement** - Per-repository policy configurations
- **Export capabilities** - JSON/CSV output for findings

</td>
<td width="50%">

### ‚ö° **Developer Experience**
- **Zero config start** - Works out of the box with sensible defaults
- **Flexible configuration** - JSON/YAML configs with Zod validation
- **Debug mode** - Comprehensive error logging with `SENTINEL_DEBUG`
- **Cache support** - Speed up repeated scans with persistent cache
- **Extensible** - Custom scanners, rotators, and rules

</td>
</tr>
</table>

---

## üìã Requirements

- **Node.js** 18+ (recommended)
- **npm** (or yarn/pnpm)

## üöÄ Quick Start

### Installation

```powershell
# Clone the repository
git clone https://github.com/sirhCC/Sentinel-ScannerRotator.git
cd Sentinel-ScannerRotator

# Install dependencies
npm install

# Build the project
npm run build
```

### Basic Usage

```powershell
# Scan a directory (dry-run mode - no changes)
npm start -- ./my-project --rotator dry-run

# Scan with detailed output
npm start -- ./my-project --rotator dry-run --log-level debug

# List available rotators
npm start -- --list-rotators

# View runtime configuration
npm start -- --show-runtime-info
```

### First Scan Example

```powershell
# Scan current directory and report findings
npm start -- . --rotator dry-run

# Export findings to JSON
npm start -- . --rotator dry-run --out findings.json

# Enable debug mode for troubleshooting
$env:SENTINEL_DEBUG = "true"
npm start -- . --rotator dry-run
```

---

## üìñ Documentation

### CLI Reference

#### Help & Information

```powershell
npm start -- --help                  # Show all options
npm start -- --version               # Display version
npm start -- --list-rotators         # List available rotators
npm start -- --show-runtime-info     # Show runtime configuration
```

#### Core Options

| Option | Description |
|--------|-------------|
| `-r, --rotator <name>` | **Rotator to use:** `dry-run` \| `apply` \| `backend` |
| `-d, --dry-run` | Report only; don't modify files |
| `-f, --force` | Required to apply changes without dry-run |
| `-I, --interactive` | Approve each finding interactively |
| `-c, --config <path>` | Path to config file or directory |
| `-i, --ignore <glob>` | Add ignore pattern (repeatable) |
| `-l, --log-level <lvl>` | Set log level: `error` \| `warn` \| `info` \| `debug` |
| `-j, --log-json` | Emit logs in JSON format |

#### Advanced Options

| Option | Description |
|--------|-------------|
| `--scan-concurrency <n>` | Concurrent file scans (default: 8) |
| `--rotate-concurrency <n>` | Concurrent rotations (default: 4) |
| `--cache <path>` | Persist scan cache to file |
| `--out <file>` | Export findings (JSON/CSV based on extension) |
| `--out-format <fmt>` | Override format: `json` \| `csv` |
| `--audit <path>` | Write NDJSON audit log |
| `-t, --template <tpl>` | Replacement template (see [Template Tokens](#template-tokens)) |
| `--verify` | Verify backend read-back before updating files |

#### CI/CD Integration

| Option | Description |
|--------|-------------|
| `--fail-on-findings` | Fail if findings exceed threshold |
| `--fail-threshold <n>` | Total findings threshold (default: 0) |
| `--fail-threshold-high <n>` | High severity threshold |
| `--fail-threshold-medium <n>` | Medium severity threshold |
| `--fail-threshold-low <n>` | Low severity threshold |
| `--min-severity <lvl>` | Minimum severity: `low` \| `medium` \| `high` |

#### Rulesets & Rules

| Option | Description |
|--------|-------------|
| `--list-rulesets` | List available curated rulesets |
| `--rulesets <names>` | Enable specific rulesets (comma-separated) |
| `--rulesets-dirs <dirs>` | Custom ruleset directories |
| `--disable-builtin-rules` | Disable built-in rule set |

#### Metrics & Monitoring

| Option | Description |
|--------|-------------|
| `--metrics-server` | Start Prometheus metrics HTTP server |
| `--metrics-port <n>` | Metrics server port (default: 9095) |
| `--metrics <path>` | Write metrics to file at end of run |

#### Subcommands

```powershell
# Undo - restore file from backup
npm start -- undo ./path/to/file.txt
```

### Environment Variables

#### Core Settings

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_DEBUG` | Enable detailed debug logging | `false` |
| `SENTINEL_TMP_DIR` | Backup/temp directory location | `.sentinel_tmp` |
| `SENTINEL_CACHE` | Persistent cache file path | _none_ |
| `SENTINEL_CACHE_MODE` | Cache validation: `mtime` \| `hash` | `mtime` |

#### Performance Tuning

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_SCAN_CONCURRENCY` | Concurrent file scans | `8` |
| `SENTINEL_ROTATE_CONCURRENCY` | Concurrent rotations | `4` |
| `SENTINEL_WORKERS` | Worker thread pool size | _disabled_ |
| `SENTINEL_REGEX_ENGINE` | Regex engine: `native` \| `re2` | `native` |

#### Scanning Behavior

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_SCAN_ARCHIVES` | Scan ZIP/TAR.GZ files | `true` |
| `SENTINEL_SCAN_BINARIES` | Scan binary files | `false` |
| `SENTINEL_ENTROPY` | Enable entropy detection | `false` |
| `SENTINEL_ENTROPY_THRESHOLD` | Entropy bits/char threshold | `3.5` |
| `SENTINEL_ENTROPY_MINLEN` | Min token length for entropy | `32` |

#### Archive Limits

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_ZIP_MAX_ENTRIES` | Max ZIP entries to scan | `1000` |
| `SENTINEL_ZIP_MAX_ENTRY_BYTES` | Max ZIP entry size | `1 MiB` |
| `SENTINEL_ZIP_MAX_BYTES` | Max total ZIP size | `10 MiB` |
| `SENTINEL_TAR_MAX_ENTRIES` | Max TAR entries to scan | `1000` |
| `SENTINEL_TAR_MAX_ENTRY_BYTES` | Max TAR entry size | `1 MiB` |
| `SENTINEL_TAR_MAX_BYTES` | Max total TAR size | `10 MiB` |

#### ML Integration

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_ML_HOOK` | Path to ML analysis module | _none_ |
| `SENTINEL_ML_MODE` | Analysis mode: `line` \| `file` \| `both` | `line` |
| `SENTINEL_ML_MAX_MS` | ML timeout per call (ms) | _none_ |

#### Backend Configuration

| Variable | Description | Default |
|----------|-------------|---------|
| `SENTINEL_BACKEND` | Backend: `file` \| `aws` \| `vault` | `file` |
| `SENTINEL_BACKEND_FILE` | File backend JSON path | `.sentinel_secrets.json` |
| `SENTINEL_BACKEND_PREFIX` | AWS secret name prefix | _none_ |
| `SENTINEL_VAULT_MOUNT` | Vault KV mount point | `secret` |
| `SENTINEL_VAULT_PATH` | Vault secret path | `sentinel` |

### Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success |
| `2` | Unknown rotator |
| `3` | Unsafe apply invocation (missing `--force`) |
| `4` | Failed due to findings (with `--fail-on-findings`) |

---

## üí° Usage Examples

### Scanning & Detection

```powershell
# Basic scan with dry-run
npm start -- ./my-repo --rotator dry-run

# Scan with custom ignore patterns
npm start -- ./my-repo --rotator dry-run --ignore "*.log" --ignore "node_modules/**"

# Enable entropy detection for high-entropy tokens
$env:SENTINEL_ENTROPY = "true"
npm start -- ./my-repo --rotator dry-run

# Scan with specific rulesets
npm start -- ./my-repo --rotator dry-run --rulesets "common,cloud,crypto"

# Export findings to different formats
npm start -- ./my-repo --rotator dry-run --out findings.json
npm start -- ./my-repo --rotator dry-run --out findings.csv
```

### Rotation & Secret Management

```powershell
# Apply rotation with template (creates backups)
npm start -- . --rotator apply --force --template "__MASKED_{{timestamp}}__"

# Interactive approval for each finding
npm start -- . --rotator apply --interactive --audit audit.ndjson

# Backend rotation (file provider)
$env:SENTINEL_BACKEND = "file"
$env:SENTINEL_BACKEND_FILE = ".sentinel_secrets.json"
npm start -- . --rotator backend --force --verify

# Backend rotation (AWS Secrets Manager)
$env:SENTINEL_BACKEND = "aws"
$env:AWS_REGION = "us-east-1"
npm start -- . --rotator backend --force --verify

# Backend rotation (HashiCorp Vault)
$env:SENTINEL_BACKEND = "vault"
$env:VAULT_ADDR = "http://127.0.0.1:8200"
$env:VAULT_TOKEN = "your-token"
npm start -- . --rotator backend --force --verify
```

### Rollback & Recovery

```powershell
# Undo changes to a specific file
npm start -- undo ./path/to/file.txt

# Use custom temp directory for isolation
$env:SENTINEL_TMP_DIR = ".sentinel_tmp_run1"
npm start -- . --rotator apply --force

# Clean up temp directory
Remove-Item -Recurse -Force ".sentinel_tmp_run1"
```

### CI/CD Integration

```powershell
# Fail pipeline if any secrets found
npm start -- . --rotator dry-run --fail-on-findings

# Allow up to 2 low-severity findings
npm start -- . --rotator dry-run --fail-on-findings --fail-threshold 2 --min-severity low

# Strict mode: zero high-severity findings allowed
npm start -- . --rotator dry-run --fail-on-findings --fail-threshold-high 0

# Export findings and fail on threshold
npm start -- . --rotator dry-run --fail-on-findings --out findings.json
```

### Performance Optimization

```powershell
# High-concurrency scanning
npm start -- . --rotator dry-run --scan-concurrency 16

# Enable persistent cache
npm start -- . --rotator dry-run --cache .sentinel_cache.json

# Use content hash for cache validation
$env:SENTINEL_CACHE_MODE = "hash"
npm start -- . --rotator dry-run --cache .sentinel_cache.json

# Enable worker thread pool
$env:SENTINEL_WORKERS = "4"
npm start -- . --rotator dry-run
```

### Monitoring & Metrics

```powershell
# Start with Prometheus metrics server
npm start -- . --rotator dry-run --metrics-server --metrics-port 9095

# Write metrics to file
npm start -- . --rotator dry-run --metrics metrics.txt

# In another terminal, query metrics
curl http://localhost:9095/metrics
curl http://localhost:9095/healthz
```

---

## ‚öôÔ∏è Configuration

### Project Configuration Files

SecretSentinel looks for configuration files in the following locations (in order):

1. `.secretsentinel.yaml` (YAML format)
2. `.secretsentinel.json` (JSON format)
3. `config/defaults.json` (fallback)

#### Configuration Schema

**JSON Example (`.secretsentinel.json`):**

```json
{
  "patterns": [
    {
      "name": "MY_API_KEY",
      "regex": "MYAPI_[A-Z0-9]{16}",
      "severity": "high",
      "enabled": true
    },
    {
      "name": "Custom_Token",
      "regex": "tok_[a-f0-9]{32}",
      "severity": "medium"
    }
  ],
  "policy": {
    "thresholds": {
      "total": 0,
      "high": 0,
      "medium": 2,
      "low": 10
    },
    "forbidRules": ["AWS Access Key ID", "GitHub Personal Access Token"],
    "minSeverity": "medium"
  }
}
```

**YAML Example (`.secretsentinel.yaml`):**

```yaml
patterns:
  - name: MY_API_KEY
    regex: MYAPI_[A-Z0-9]{16}
    severity: high
    enabled: true
  
  - name: Custom_Token
    regex: tok_[a-f0-9]{32}
    severity: medium

policy:
  thresholds:
    total: 0
    high: 0
    medium: 2
    low: 10
  forbidRules:
    - AWS Access Key ID
    - GitHub Personal Access Token
  minSeverity: medium
```

### Configuration Validation

All configurations are validated using **Zod schemas** at load time:

#### Pattern Validation

- **`name`**: Must be a non-empty string
- **`regex`**: Must be a valid JavaScript regular expression
- **`severity`**: Must be `low`, `medium`, or `high` (optional)
- **`enabled`**: Must be boolean (optional, defaults to `true`)

#### Policy Validation

- **`thresholds`**: Must be non-negative integers (if specified)
- **`forbidRules`**: Must be an array of non-empty strings (if specified)
- **`minSeverity`**: Must be `low`, `medium`, or `high` (if specified)

Invalid configurations will fail fast with detailed error messages.

### Ignore Files

SecretSentinel respects gitignore-style patterns from:

- `.gitignore` (automatically detected)
- `.secretignore` (custom ignore file)
- CLI flags: `--ignore <pattern>` (repeatable)

**Example `.secretignore`:**

```gitignore
# Ignore test fixtures
test/fixtures/**

# Ignore generated files
dist/**
*.min.js

# Ignore documentation
docs/**
```

### Policy Configuration

Policy configurations guide CI/CD behavior when using `--fail-on-findings`:

- **`thresholds`**: Maximum allowed findings per severity level
- **`forbidRules`**: Rules that trigger immediate failure
- **`minSeverity`**: Minimum severity level to consider

**Precedence:** CLI flags > Policy config > Defaults

---

## üîê Rotators & Extensibility

### Built-in Rotators

| Rotator | Description | Use Case |
|---------|-------------|----------|
| **`dry-run`** | Report findings without modifications | Safe scanning, reporting |
| **`apply`** | Replace matches using templates | Masking secrets in place |
| **`backend`** | Store in backend, replace with reference | Production secret management |

### Template Tokens

Use these tokens in `--template` for dynamic replacements:

| Token | Description | Example Output |
|-------|-------------|----------------|
| `{{match}}` | The exact matched secret ‚ö†Ô∏è | `sk_live_abc123...` |
| `{{timestamp}}` | Current timestamp (ms) | `1699900800000` |
| `{{file}}` | File path containing match | `src/config.ts` |
| `{{ref}}` | Backend reference (backend only) | `secretref://file/key_abc123` |

**Template Examples:**

```powershell
# Mask with timestamp
--template "__MASKED_{{timestamp}}__"

# Mask with file context
--template "__REDACTED_{{file}}_{{timestamp}}__"

# Backend reference (with backend rotator)
--template "{{ref}}"
```

### Custom Rotators

#### JavaScript Rotator

```javascript
// rotators/myRotator.js
export const myRotator = {
  name: 'my-custom-rotator',
  
  async rotate(finding, options) {
    // finding: { filePath, line, column, match, rule }
    // options: { dryRun, force, template, ... }
    
    console.log(`Processing ${finding.filePath}:${finding.line}`);
    
    return {
      success: true,
      message: `Rotated secret in ${finding.filePath}`
    };
  }
};
```

#### TypeScript Rotator

```typescript
// rotators/myRotator.ts
import { defineRotator, Rotator } from '../../src/rotators/schema';

export const myRotator: Rotator = defineRotator({
  name: 'my-custom-rotator',
  
  async rotate(finding, options) {
    // Type-safe implementation
    return {
      success: true,
      message: `Rotated secret in ${finding.filePath}`
    };
  },
});
```

#### Using Custom Rotators

```powershell
# Build project first
npm run build

# Run with custom rotator
npm start -- . --rotators-dir ./rotators --rotator my-custom-rotator --dry-run
```

---

## üóÑÔ∏è Backend Providers

### File Backend (Default)

Stores secrets in a local JSON file.

```powershell
$env:SENTINEL_BACKEND = "file"
$env:SENTINEL_BACKEND_FILE = ".sentinel_secrets.json"
npm start -- . --rotator backend --force --verify
```

**Output format (`.sentinel_secrets.json`):**

```json
{
  "key_abc123": {
    "value": "sk_live_actual_secret_here",
    "file": "src/config.ts",
    "line": 42,
    "timestamp": 1699900800000
  }
}
```

### AWS Secrets Manager

Requires `@aws-sdk/client-secrets-manager` package.

```powershell
# Install AWS SDK
npm install @aws-sdk/client-secrets-manager

# Configure
$env:SENTINEL_BACKEND = "aws"
$env:AWS_REGION = "us-east-1"
$env:SENTINEL_BACKEND_PREFIX = "myapp/"  # Optional prefix

npm start -- . --rotator backend --force --verify
```

### HashiCorp Vault

Uses Vault KV v2 engine via HTTP API.

```powershell
$env:SENTINEL_BACKEND = "vault"
$env:VAULT_ADDR = "http://127.0.0.1:8200"
$env:VAULT_TOKEN = "your-vault-token"

# Optional configuration
$env:SENTINEL_VAULT_MOUNT = "secret"      # Default: secret
$env:SENTINEL_VAULT_PATH = "sentinel"     # Default: sentinel
$env:VAULT_NAMESPACE = "myapp"            # Optional

npm start -- . --rotator backend --force --verify
```

---

## üìã Audit Logging

### NDJSON Audit Trail

Enable append-only audit logging with `--audit <path>`:

```powershell
npm start -- . --rotator apply --interactive --audit audit.ndjson
```

**Event Format:**

```json
{
  "ts": 1699900800000,
  "file": "src/app.ts",
  "line": 10,
  "column": 15,
  "match": "API_KEY=secret123",
  "rule": "Generic API Key",
  "severity": "medium",
  "rotator": "apply",
  "dryRun": false,
  "verify": true,
  "success": true,
  "message": "updated src/app.ts",
  "hash": "sha256:abc123..."
}
```

### Signed Audit Logs

Add HMAC signatures for tamper-detection:

```powershell
$env:SENTINEL_AUDIT_SIGN_KEY = "your-secret-signing-key"
$env:SENTINEL_AUDIT_SIGN_KEY_ID = "key-2024-01"  # Optional

npm start -- . --rotator apply --audit audit.ndjson
```

Events will include:

- `hash`: SHA-256 hash of event payload
- `sig`: HMAC-SHA256 signature
- `keyId`: Key identifier (optional)

---

## üìä Rules & Detection

- `.secretsentinel.yaml` (YAML)
- `.secretsentinel.json` (JSON)

Example JSON (`.secretsentinel.json`):

```json
{
  "patterns": [
    { "name": "MY_API_KEY", "regex": "MYAPI_[A-Z0-9]{16}", "severity": "high" }
  ]
}
```

Example YAML (`.secretsentinel.yaml`):

```yaml
patterns:
  - name: MY_API_KEY
    regex: MYAPI_[A-Z0-9]{16}
```

Configuration validation:

- Patterns are validated using Zod schemas at load time
- **Pattern name**: must be non-empty string
- **Regex**: must be a valid JavaScript regular expression
- **Severity**: must be `low`, `medium`, or `high` (if specified)
- **Enabled**: must be boolean (if specified)
- Invalid configurations will throw errors with specific validation messages

Notes:

- If `js-yaml` isn't installed, YAML parsing is skipped; JSON/defaults are used.
- `--config <path>` can point at a file or directory; if a file, its directory is used as the base for lookup.

## Ignore rules

The scanner respects patterns from `.gitignore` and `.secretignore` in the scan root. You can supplement with `--ignore <glob>` (repeatable).

## Rotators and extensibility

Built-in rotators:

- `dry-run` ‚Äî report what would change
- `apply` ‚Äî replace matches in files using a template
- `backend` ‚Äî store secrets in a backend and replace with a portable reference

Discover custom rotators from additional directories with `--rotators-dir <dir>`.

Authoring a rotator (JS):

```js
// plugins/rotators/myRotator.js
export const myRotator = {
  name: 'my-rotator',
  async rotate(finding, options) {
    return { success: true, message: `handled ${finding.filePath}:${finding.line}` };
  }
};
```

Authoring a rotator (TS):

```ts
// plugins/rotators/myRotator.ts
import { defineRotator, Rotator } from '../../src/rotators/schema';

export const myRotator: Rotator = defineRotator({
  name: 'my-rotator',
  async rotate(finding, options) {
    return { success: true, message: `handled ${finding.filePath}:${finding.line}` };
  },
});
```

Run with your rotator directory:

```powershell
npm run build
npm start -- . --rotators-dir .\plugins\rotators --rotator my-rotator --dry-run
```

## Backend rotator

The `backend` rotator stores the matched secret and replaces it with a reference like `secretref://<provider>/<key>`.

Providers:

- file (default): JSON map in `.sentinel_secrets.json` (override with `SENTINEL_BACKEND_FILE`).
- aws (optional): AWS Secrets Manager (install `@aws-sdk/client-secrets-manager`; set `AWS_REGION` or `AWS_DEFAULT_REGION`).
- vault (optional): HashiCorp Vault KV v2 via HTTP (uses global `fetch`). Requires `VAULT_ADDR` and `VAULT_TOKEN`. Optional `SENTINEL_VAULT_MOUNT` (default `secret`) and `SENTINEL_VAULT_PATH` (default `sentinel`). Supports `VAULT_NAMESPACE`.

Environment variables:

- `SENTINEL_BACKEND` ‚Äî `file` (default), `aws`, or `vault`.
- `SENTINEL_BACKEND_FILE` ‚Äî JSON secrets file path for file backend.
- `SENTINEL_BACKEND_PREFIX` ‚Äî optional AWS secret name prefix.

Examples:

```powershell
# File backend (default)
$env:SENTINEL_BACKEND = 'file'; $env:SENTINEL_BACKEND_FILE = '.sentinel_secrets.json'
npm start -- . --rotator backend --force

# AWS Secrets Manager (requires SDK and AWS creds/region)
# npm install @aws-sdk/client-secrets-manager
$env:SENTINEL_BACKEND = 'aws'; $env:AWS_REGION = 'us-east-1'
npm start -- . --rotator backend --force

# HashiCorp Vault (KV v2)
$env:SENTINEL_BACKEND = 'vault'; $env:VAULT_ADDR = 'http://127.0.0.1:8200'; $env:VAULT_TOKEN = '<token>'
# optional: $env:SENTINEL_VAULT_MOUNT = 'secret'; $env:SENTINEL_VAULT_PATH = 'sentinel'; $env:VAULT_NAMESPACE = 'myns'
npm start -- . --rotator backend --force
```

Verification: add `--verify` to read back the stored value before modifying files.

## Performance: concurrency, caching, and throttling

- Scanning uses a worker pool. Configure with `--scan-concurrency <n>` or `SENTINEL_SCAN_CONCURRENCY`.
- Rotations run concurrently but never edit the same file in parallel. Configure with `--rotate-concurrency <n>` or `SENTINEL_ROTATE_CONCURRENCY`.
- Speed up repeated scans by enabling a persistent scan cache: `--cache <file>` or `SENTINEL_CACHE`.
- Archive scanning:
  - Toggle on/off for all archives with `SENTINEL_SCAN_ARCHIVES` ("false"/"0"/"no" disables).
  - ZIP guardrails: `SENTINEL_ZIP_MAX_ENTRIES` (default 1000), `SENTINEL_ZIP_MAX_ENTRY_BYTES` (default 1 MiB), `SENTINEL_ZIP_MAX_BYTES` (default 10 MiB).
  - TAR.GZ guardrails: `SENTINEL_TAR_MAX_ENTRIES` (default 1000), `SENTINEL_TAR_MAX_ENTRY_BYTES` (default 1 MiB), `SENTINEL_TAR_MAX_BYTES` (default 10 MiB).
- Cache modes: set `SENTINEL_CACHE_MODE=hash` to validate cache hits by SHA-256 content hash (default `mtime` uses mtime+size).
- Optional worker pool: set `SENTINEL_WORKERS=<n>` to offload scanning to worker threads. This can improve throughput on CPU-bound regex scans. The pool is ignored if the worker file isn‚Äôt built or when running tests.

Example (PowerShell):

```powershell
npm start -- . --rotator dry-run --scan-concurrency 16 --rotate-concurrency 8 --cache .\.sentinel\cache.json
```

Use stronger cache validation:

```powershell
$env:SENTINEL_CACHE_MODE = 'hash'; npm start -- . --rotator dry-run --cache .\.sentinel\cache.json
```

## Rules, severities, and entropy

- Rules come from built-ins plus project config. Built-ins include AWS Access Key ID (high), a generic API key pattern (medium), and JWT-like strings (low).
- Custom rules can be added via `.secretsentinel.json`/`.secretsentinel.yaml` using the existing `patterns` array; optional fields `severity` (low|medium|high) and `enabled: false` are supported.
- Findings include `rule` and `severity` when available. Exports (JSON/CSV) include these fields.
- Opt-in entropy detector: set `SENTINEL_ENTROPY=true` to flag high-entropy tokens (base64/hex-like) above a threshold. Future flags may allow tuning the threshold.

### Curated rulesets and marketplace

- List curated rulesets: `npm start -- --list-rulesets`.
- Enable curated rulesets: `--rulesets "common,cloud"` or `SENTINEL_RULESETS`.
- Discover external rulesets from directories with `--rulesets-dirs ".\\curated;C:\\more"` (files named `*.ruleset.json`).
- Disable built-ins with `--disable-builtin-rules` or `SENTINEL_DISABLE_BUILTIN_RULES=true`.

Install from a catalog and enforce signatures:

```powershell
# Install from a catalog into cache dir
sentinel --rulesets-catalog .\catalog.json --rulesets-install common,cloud --rulesets-cache-dir .\.sentinel_rulesets

# Require signed rulesets using a PEM public key (file or inline content)
sentinel --rulesets-catalog .\catalog.json --rulesets-install common \
  --rulesets-require-signed --rulesets-pubkey .\rules_pubkey.pem

# Require the catalog itself to be signed via a detached .sig file
sentinel --rulesets-catalog .\catalog.json --rulesets-install common \
  --rulesets-catalog-require-signed --rulesets-catalog-pubkey .\catalog_pubkey.pem
```

### ML model hook (optional)

- Provide `SENTINEL_ML_HOOK` path or spec to a module exporting `analyzeLine(line, {filePath, lineNumber})` returning tokens.
- Findings from ML are tagged as `ML-Hook` unless `ruleName` is set.
- Optional timeout: `SENTINEL_ML_MAX_MS` caps per-call time; when exceeded, the call is skipped.
  - Metrics: `sentinel_ml_invocations_total`, `sentinel_ml_time_ms_total`, `sentinel_ml_errors_total`, `sentinel_ml_findings_total`.

File-level analysis:

- You can also export `analyzeFile(lines: string[], {filePath})` for whole-file heuristics (e.g., multi-line key blocks).
- Choose ML mode via `SENTINEL_ML_MODE`: `line` (default), `file`, or `both`.
- Example module: `examples/ml/simple.mjs` shows both functions.

### Binary scanning (optional)

- Enable with `SENTINEL_SCAN_BINARIES=true`; scans small binary files (<= 2 MiB) by decoding to UTF-8 and applying rules.

## Metrics HTTP server

Expose Prometheus metrics and a simple health check over HTTP.

- Start the server: pass `--metrics-server` (default port 9095) or additionally `--metrics-port <n>`.
- Endpoints:
  - `/healthz` returns 200 OK and the text "ok".
  - `/metrics` returns Prometheus format metrics like:
    - `sentinel_findings_total`
    - `sentinel_findings_severity_total{severity="low|medium|high"}`
    - `sentinel_rotations_total`, `sentinel_rotations_success_total`, `sentinel_rotations_failed_total`
    - `sentinel_rules_compiled_total`
    - `sentinel_files_skipped_total`
    - `sentinel_files_skipped_reason_total{reason="..."}`
    - `sentinel_runtime_info{engine=...,workers=...,cache_mode=...,scan_concurrency=...,rotate_concurrency=...,version=...} 1`

You can still write metrics to a file at the end of the run with `--metrics <path>`.

Prometheus examples:

```bash
# List current runtime configurations
sentinel_runtime_info

# Group by engine and worker count
sum by (engine, workers) (sentinel_runtime_info)
```

### Policy (optional)

You can add a `policy` block in `.secretsentinel.json`/`.secretsentinel.yaml` (or `config/defaults.json`) to guide CI gating when using `--fail-on-findings`:

Example JSON:

```json
{
  "policy": {
    "thresholds": { "total": 0, "high": 0, "medium": 2, "low": 10 },
    "forbidRules": ["AWS Access Key ID"],
    "minSeverity": "medium"
  }
}
```

Policy validation:

- **Thresholds**: must be non-negative integers (if specified)
- **ForbidRules**: must be array of non-empty strings (if specified)
- **MinSeverity**: must be `low`, `medium`, or `high` (if specified)
- Invalid policies will throw errors with specific validation messages

Semantics and precedence:

- `minSeverity`: findings are filtered to only those at or above this severity before threshold checks. For example, `minSeverity: "medium"` excludes low severity findings from threshold counting.
  - You can override this via CLI: `--min-severity <low|medium|high>`.
- Thresholds evaluation order: CLI flags have priority (e.g., `--fail-threshold`, `--fail-threshold-high|medium|low`), falling back to policy values, then defaults (total defaults to 0 when `--fail-on-findings` is used).
- `forbidRules`: if any listed rule matches, the run fails immediately when `--fail-on-findings` is set.
- Policy discovery is rooted at the scan target (or `--config` path if provided). This lets per-repo policies travel with the scanned project.

CLI flags override the policy thresholds when provided.

## Development

Build, test, lint, and format:

```powershell
npm run build
npm test
npm run lint
npm run format
```

Run locally (dev):

```powershell
npm run dev -- . --rotator dry-run
```

## Jupyter Notebook extension (example)

A minimal classic Notebook nbextension lives in `examples/nbext/`. It adds a toolbar button that scans cells for common secret patterns client-side and shows findings. See `examples/nbext/README.md` for install instructions.

## Security and safety

- This tool can modify files when not in `--dry-run`. Prefer dry-runs first and require `--force` (or `--interactive`).
- Review `SECURITY.md` for threat model and operational guidance.

## License

MIT License. See `LICENSE`.


